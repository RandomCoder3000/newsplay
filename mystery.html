<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NewsPlay â€” Mystery Missions</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .pop{transition:transform 120ms ease}.pop:active{transform:scale(.98)}
    .hint{display:none}.hint.show{display:block}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-rose-50 to-white text-slate-800">
  <header class="max-w-5xl mx-auto px-4 pt-6">
    <div class="flex items-center justify-between gap-3 flex-wrap">
      <div class="flex items-center gap-2">
        <a href="index.html" class="pop px-3 py-2 rounded-xl bg-slate-200">â† Home</a>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">ğŸ•µï¸ Mystery Missions</h1>
      </div>
      <div class="flex items-center gap-4">
        <div class="hidden md:flex items-center gap-2 text-sm">
          <span class="text-slate-600">Badges:</span>
          <div id="badge-shelf" class="flex gap-1"></div>
        </div>
        <div class="flex gap-2" role="tablist" aria-label="Age tiers">
          <button class="age-btn pop px-3 py-2 rounded-xl bg-indigo-600 text-white" data-tier="6_8">6â€“8</button>
          <button class="age-btn pop px-3 py-2 rounded-xl bg-indigo-100" data-tier="9_11">9â€“11</button>
          <button class="age-btn pop px-3 py-2 rounded-xl bg-indigo-100" data-tier="12_14">12â€“14</button>
        </div>
      </div>
    </div>
    <p class="mt-2 text-slate-600 text-sm">Pick a mission, collect evidence, try a tiny simulation, and write your claim. Earn badges as you go!</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-24">
    <!-- Mission chooser -->
    <section class="mt-6 p-4 bg-white rounded-2xl shadow">
      <h2 class="font-bold">Choose a mission</h2>
      <div id="missions" class="mt-3 grid sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
    </section>

    <!-- Evidence board + mini-sim + claim builder -->
    <section class="mt-6 p-4 bg-white rounded-2xl shadow">
      <div class="flex items-start justify-between gap-3 flex-wrap">
        <div>
          <h3 id="m-title" class="text-xl font-bold">â€”</h3>
          <p id="m-sub" class="text-sm text-slate-600">â€”</p>
        </div>
        <div class="flex gap-2">
          <button id="btn-reset" class="pop px-3 py-2 rounded-xl bg-slate-200">Reset mission</button>
        </div>
      </div>

      <!-- Evidence -->
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div class="p-3 rounded-xl bg-gradient-to-br from-rose-50 to-pink-50">
          <h4 class="font-semibold">Evidence Board</h4>
          <div id="evidence" class="mt-2 space-y-2"></div>
          <p class="text-xs text-slate-500 mt-2">Tip: Collect at least 3 items to earn the ğŸ§© Evidence Collector badge.</p>
        </div>

        <!-- Mini-sim -->
        <div class="p-3 rounded-xl bg-gradient-to-br from-amber-50 to-yellow-50">
          <h4 class="font-semibold">Tiny Simulation</h4>
          <div class="text-sm text-slate-700">Move the sliders to test a what-if scenario.</div>
          <div class="mt-3">
            <label class="text-sm">Demand change (%)</label>
            <input id="sim-demand" type="range" min="-50" max="50" value="10" class="w-full">
            <div class="text-xs"><span id="sim-demand-val">+10%</span></div>
          </div>
          <div class="mt-3">
            <label class="text-sm">Supply change (%)</label>
            <input id="sim-supply" type="range" min="-50" max="50" value="-10" class="w-full">
            <div class="text-xs"><span id="sim-supply-val">-10%</span></div>
          </div>
          <div class="mt-3 p-3 rounded-xl bg-white shadow text-sm">
            <div>Predicted price direction: <b id="sim-price">up</b></div>
            <div>Predicted quantity direction: <b id="sim-qty">uncertain</b></div>
            <div class="mt-1 text-xs text-slate-500">Heuristic: demandâ†‘ â†’ pricesâ†‘; supplyâ†‘ â†’ pricesâ†“. Mix them to see the direction.</div>
          </div>
        </div>
      </div>

      <!-- Claim builder -->
      <div class="mt-4 p-3 rounded-xl bg-gradient-to-br from-emerald-50 to-teal-50">
        <h4 class="font-semibold">Claim Builder</h4>
        <p class="text-sm text-slate-700">Write one paragraph explaining your claim using at least two evidence items and the sim result.</p>
        <textarea id="claim" class="mt-2 w-full h-28 p-2 rounded-lg border" placeholder="Example: Prices rose because demand increased while supply fell. Evidence: â€¦"></textarea>
        <div class="mt-2 flex gap-2">
          <button id="btn-score" class="pop px-3 py-2 rounded-xl bg-indigo-600 text-white">Score my claim</button>
          <button id="btn-export" class="pop px-3 py-2 rounded-xl bg-emerald-100">Export</button>
        </div>
        <div id="score" class="mt-2 text-sm"></div>
        <div id="hints" class="hint mt-2 text-xs text-slate-600"></div>
      </div>
    </section>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // Storage & badges
    const PREFS_KEY='np_prefs_v1', MYST_KEY='np_mystery_v1', BADGES_KEY='np_badges_v1';
    function getPrefs(){ try{return JSON.parse(localStorage.getItem(PREFS_KEY))||{}}catch{return{}} }
    function setPrefs(p){ localStorage.setItem(PREFS_KEY, JSON.stringify(p)); }
    function getBadges(){ try{return JSON.parse(localStorage.getItem(BADGES_KEY))||[]}catch{return[]} }
    function addBadge(name,emoji){
      const list=getBadges(); if(!list.find(b=>b.name===name)){ list.push({name,emoji,ts:Date.now()}); localStorage.setItem(BADGES_KEY, JSON.stringify(list)); renderBadges(); }
    }
    function renderBadges(){ const shelf=document.getElementById('badge-shelf'); if(!shelf) return; shelf.innerHTML=''; getBadges().forEach(b=>{ const s=document.createElement('span'); s.textContent=b.emoji; s.title=b.name; shelf.appendChild(s); }); }

    // Tiering
    let currentTier=(getPrefs().tier)||'6_8';
    function paintTier(){
      document.querySelectorAll('.age-btn').forEach(b=> b.className='age-btn pop px-3 py-2 rounded-xl bg-indigo-100');
      const active=document.querySelector('.age-btn[data-tier="'+currentTier+'"]');
      if(active) active.className='age-btn pop px-3 py-2 rounded-xl bg-indigo-600 text-white';
    }
    document.querySelectorAll('.age-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        currentTier=btn.dataset.tier;
        const p=getPrefs(); p.tier=currentTier; setPrefs(p);
        paintTier(); renderMission();
      });
    });

    // Missions
    const MISSIONS=[{
      id:'fruit-prices',
      title:'Are fruit prices rising this month?',
      sub:'Use supply & demand clues to explain changes.',
      ev:{
        '6_8':['Fewer fruit trucks arrived','More people wanted fruit','Bad weather hurt crops','Shop had a sale','Festival weekend crowd'],
        '9_11':['Lower supply from farms','Higher local demand','Fuel price increased','Importer added fees','Fruit quality improved'],
        '12_14':['Supply shock from weather','Demand spike (festival)','Higher transport costs','Tariff on imports','Retailer promotion']
      }
    },{
      id:'bus-fares',
      title:'Why did bus fares change?',
      sub:'Explore fuel costs, ridership, and city policy.',
      ev:{
        '6_8':['Fuel got expensive','More people used buses','City helped with money','New buses arrived','Holiday travel rush'],
        '9_11':['Diesel price rose','Ridership increased','Subsidy added/removed','Maintenance costs rose','Competition from taxis'],
        '12_14':['Fuel-cost pass-through','Fare elasticity & ridership','Budget subsidy change','Capex/opex pressure','Modal shift effects']
      }
    },{
      id:'canteen-meals',
      title:'Why did canteen meal prices change?',
      sub:'Track ingredients cost and demand at school.',
      ev:{
        '6_8':['Veggies cost more','More students eating','Chef made bigger portions','Discount day started','Supplier changed'],
        '9_11':['Input costs rose','Demand increased','Menu upgrade','Bulk discount ended','Supplier switch'],
        '12_14':['Input cost index â†‘','Demand trend â†‘','Quality upgrade costs','Volume discounts ended','Vendor renegotiation']
      }
    }];

    // UI holders
    const box=document.getElementById('missions');
    const eBox=document.getElementById('evidence');
    const dEl=document.getElementById('sim-demand'), sEl=document.getElementById('sim-supply');
    const dVal=document.getElementById('sim-demand-val'), sVal=document.getElementById('sim-supply-val');
    const priceOut=document.getElementById('sim-price'), qtyOut=document.getElementById('sim-qty');
    const claimEl=document.getElementById('claim'), scoreEl=document.getElementById('score'), hintsEl=document.getElementById('hints');
    let current = 'fruit-prices';

    function getSaved(){ try{return JSON.parse(localStorage.getItem(MYST_KEY))||{}}catch{return{}} }
    function setSaved(obj){ localStorage.setItem(MYST_KEY, JSON.stringify(obj)); }

    function mountMissions(){
      if(!box) return;
      box.innerHTML='';
      MISSIONS.forEach(m=>{
        const a=document.createElement('a');
        a.href='#'; a.className='pop p-4 rounded-2xl bg-white border hover:shadow block';
        a.innerHTML='<div class="text-2xl">ğŸ§©</div><div class="font-semibold">'+m.title+'</div><div class="text-sm text-slate-600">'+m.sub+'</div>';
        a.addEventListener('click',(e)=>{ e.preventDefault(); current=m.id; renderMission(); addBadge('Case Picker','ğŸ§©'); });
        box.appendChild(a);
      });
    }

    function renderMission(){
      const m=MISSIONS.find(x=>x.id===current); if(!m) return;
      document.getElementById('m-title').textContent=m.title;
      document.getElementById('m-sub').textContent=m.sub;

      // Evidence
      if(eBox) eBox.innerHTML='';
      const list=m.ev[currentTier]||m.ev['6_8'];
      list.forEach((t,i)=>{
        const id='ev-'+m.id+'-'+i;
        const r=document.createElement('div');
        r.innerHTML='<label class="text-sm flex gap-2 items-start"><input type="checkbox" id="'+id+'"/> <span>'+t+'</span></label>';
        eBox.appendChild(r);
        const saved=getSaved(); if(saved?.ev?.[m.id]?.includes(i)) r.querySelector('input').checked=true;
        r.querySelector('input').addEventListener('change',()=>{
          const s=getSaved(); s.ev=s.ev||{}; const set=new Set(s.ev[m.id]||[]);
          r.querySelector('input').checked ? set.add(i) : set.delete(i);
          s.ev[m.id]=Array.from(set); setSaved(s);
          if((s.ev[m.id]||[]).length>=3) addBadge('Evidence Collector','ğŸ§©');
        });
      });

      // Restore claim
      const s=getSaved(); const c=(s.claims||{})[m.id]||'';
      claimEl.value=c;

      onSimChange(); // sync sim outputs
    }

    function onSimChange(){
      const d=+dEl.value, s=+sEl.value;
      dVal.textContent=(d>0?'+':'')+d+'%';
      sVal.textContent=(s>0?'+':'')+s+'%';
      const net=d - s;  priceOut.textContent = net>5 ? 'up' : net<-5 ? 'down' : 'about the same';
      const qty=d + s;  qtyOut.textContent   = qty>5 ? 'up' : qty<-5 ? 'down' : 'about the same';
    }

    dEl.addEventListener('input', onSimChange);
    sEl.addEventListener('input', onSimChange);

    document.getElementById('btn-score').addEventListener('click',()=>{
      const m=MISSIONS.find(x=>x.id===current);
      const saved=getSaved(); const evidences=(saved.ev?.[m.id]||[]).length;
      const txt=claimEl.value.trim();
      let score=0, tips=[];
      if(txt.length>=60){ score+=1 } else tips.push('Write 2â€“3 sentences.');
      if(/because|due to|since/i.test(txt)){ score+=1 } else tips.push('Use â€œbecauseâ€ or â€œdue toâ€.');
      if(evidences>=2){ score+=1 } else tips.push('Use at least 2 evidence items.');
      scoreEl.textContent='Score: '+score+'/3';
      hintsEl.textContent=tips.join(' ');
      hintsEl.classList.toggle('show', tips.length>0);
      if(score===3) addBadge('Claim Maker','âœï¸');

      const s=getSaved(); s.claims=s.claims||{}; s.claims[m.id]=txt; setSaved(s);
    });

    document.getElementById('btn-export').addEventListener('click',()=>{
      const m=MISSIONS.find(x=>x.id===current);
      const s=getSaved(); const list=(s.ev?.[m.id]||[]).map(i=>(m.ev[currentTier]||m.ev['6_8'])[i]||'');
      const claim=(s.claims||{})[m.id]||claimEl.value||'';
      const text=['NewsPlay â€” Mystery Missions','Mission: '+m.title,'Tier: '+currentTier,'Evidence: '+(list.join('; ')||'none'),'Claim:',claim].join('\n');
      const blob=new Blob([text],{type:'text/plain;charset=utf-8'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='newsplay-mystery.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
    });

    document.getElementById('btn-reset').addEventListener('click',()=>{
      if(!confirm('Reset this mission?')) return;
      const s=getSaved(); delete (s.ev||{})[current]; delete (s.claims||{})[current]; setSaved(s); renderMission();
    });

    // Init
    renderBadges(); paintTier(); mountMissions(); renderMission();
  });
  </script>
</body>
</html>
